<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Music Library — Clean Layout</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{
  --bg:#0f1113;
  --panel:#141619;
  --muted:#9aa0a6;
  --accent:#1db954;
  --text:#e8eef1;
  --glass:rgba(255,255,255,0.03);
  --radius:12px;
  --container:1100px;
  --shadow: 0 8px 30px rgba(2,6,23,0.6);
  --transition:220ms cubic-bezier(.2,.8,.2,1);
  --control-size:48px;
}
html.light{
  --bg:#f7f8fa; --panel:#ffffff; --muted:#6b6f73; --accent:#1db954; --text:#0b0b0b; --glass:rgba(0,0,0,0.03);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial;background:linear-gradient(180deg,var(--bg),#071017);color:var(--text);-webkit-font-smoothing:antialiased;min-height:100vh}
.container{max-width:var(--container);margin:0 auto;padding:28px}
.header{position:sticky;top:0;z-index:60;background:transparent;padding-top:8px;padding-bottom:8px}
.header-inner{display:flex;align-items:center;justify-content:space-between;gap:18px}
.brand{display:flex;gap:12px;align-items:center;color:var(--accent);font-weight:700}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#15a84a);display:grid;place-items:center;color:#fff;font-weight:700;box-shadow:var(--shadow)}
.controls{display:flex;gap:10px;align-items:center}
.badge{background:rgba(255,255,255,0.03);padding:6px 12px;border-radius:999px;color:var(--muted);font-size:13px}
.icon-btn{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;border:none;background:var(--panel);cursor:pointer;color:var(--text);box-shadow:var(--shadow)}
.btn{display:inline-flex;align-items:center;gap:10px;padding:8px 14px;border-radius:999px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);cursor:pointer;transition:all var(--transition)}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(0,0,0,0.35)}
.hero{display:flex;align-items:flex-start;gap:20px;margin:28px 0 18px;flex-wrap:wrap}
.hero-left{flex:1 1 540px;min-width:260px}
.title{font-size:32px;font-weight:700;letter-spacing:-0.3px;margin:0}
.subtitle{color:var(--muted);margin-top:8px;margin-bottom:18px}
.search{display:flex;align-items:center;gap:12px;background:var(--panel);padding:10px;border-radius:999px;max-width:640px}
.search input{border:0;background:transparent;color:var(--text);outline:0;width:100%;font-size:15px}
.tabs{display:flex;gap:8px;margin-top:14px}
.tab{padding:8px 14px;border-radius:999px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted)}
.tab.active{background:linear-gradient(90deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));color:var(--text);border-color:rgba(255,255,255,0.06)}
.quick{margin-left:auto;text-align:right;color:var(--muted);font-size:13px}

/* Grid and cards */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px;margin-top:18px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;box-shadow:var(--shadow);transition:transform var(--transition), box-shadow var(--transition)}
.card:hover{transform:translateY(-6px)}
.cover{height:180px;width:100%;object-fit:cover;background:#222;border-bottom:1px solid rgba(255,255,255,0.03)}
.card-body{padding:12px;display:flex;flex-direction:column;gap:8px}
.title-sm{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.artist{font-size:13px;color:var(--muted)}
.card-row{display:flex;align-items:center;gap:8px;margin-top:6px;flex-wrap:wrap}
.card .btn{padding:6px 10px;font-size:13px;border-radius:8px}

/* No results */
.no-results{padding:36px;text-align:center;color:var(--muted);background:var(--panel);border-radius:12px}

/* Upload area */
.upload-area{border:2px dashed rgba(255,255,255,0.04);border-radius:12px;padding:20px;text-align:center;cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
.upload-area:hover{border-color:rgba(255,255,255,0.06)}

/* Now playing modal (cleaner, split layout) */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:120;padding:20px}
.modal.open{display:flex}
.modal-card{max-width:940px;width:100%;background:var(--panel);padding:18px;border-radius:12px;max-height:86vh;overflow:auto;display:flex;gap:18px;align-items:flex-start}
.now-left{flex:0 0 44%;display:flex;flex-direction:column;align-items:center;gap:12px}
.now-playing-cover{width:100%;border-radius:10px;object-fit:cover;box-shadow:var(--shadow)}
.now-right{flex:1;display:flex;flex-direction:column;gap:12px}
.now-title{font-size:20px;font-weight:700}
.now-artist{color:var(--muted)}
.now-controls{display:flex;align-items:center;gap:12px;margin-top:10px}
.now-big-play{width:80px;height:80px;border-radius:50%;display:grid;place-items:center;border:none;background:linear-gradient(180deg,var(--accent),#15a84a);color:white;font-size:30px;cursor:pointer;box-shadow:0 10px 30px rgba(26,133,63,0.28)}
.progress-row{display:flex;align-items:center;gap:12px}
.progress{position:relative;height:8px;background:rgba(255,255,255,0.04);border-radius:999px;flex:1;cursor:pointer;overflow:hidden}
.progress .buffer{position:absolute;left:0;top:0;height:100%;width:0;background:rgba(255,255,255,0.06)}
.progress .bar{position:absolute;left:0;top:0;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#15a84a);border-radius:999px;transition:width 120ms linear}
.progress .thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:12px;height:12px;border-radius:50%;background:#fff;left:0;pointer-events:none;opacity:0;transition:opacity 120ms}
.progress:hover .thumb{opacity:1}

/* Bottom player bar (compact and centered) */
.player{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;margin:auto;max-width:960px;width:calc(100% - 48px);background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:10px;border-radius:14px;display:flex;gap:12px;align-items:center;box-shadow:0 14px 40px rgba(2,6,23,0.6);z-index:80}
.track{display:flex;gap:12px;align-items:center;min-width:0}
.track img{width:56px;height:56px;border-radius:10px;object-fit:cover}
.meta .t{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}
.meta .a{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}
.progress-wrap{display:flex;flex-direction:column;gap:8px;flex:1;margin:0 10px}
.controls-compact{display:flex;gap:8px;align-items:center}

/* responsive */
@media (max-width:920px){
  .modal-card{flex-direction:column}
  .now-left{flex-basis:auto;width:100%}
  .now-right{width:100%}
  .player{width:calc(100% - 28px)}
  .meta .t, .meta .a{max-width:140px}
}
@media (max-width:560px){
  .grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
  .title{font-size:22px}
  .search{padding:8px}
  .card .cover{height:140px}
}
</style>
</head>
<body>
<header class="header">
  <div class="container header-inner">
    <div class="brand">
      <div class="logo" aria-hidden="true">CS</div>
      <div>
        <div style="font-size:16px">CSpotify</div>
        <div style="font-size:12px;color:var(--muted)">Persistent Upload Demo</div>
      </div>
    </div>

    <div class="controls" role="group" aria-label="Top controls">
      <div class="badge" id="favoritesCount">0 favorites</div>
      <button class="icon-btn" id="toggleTheme" title="Toggle theme" aria-pressed="false"><i class="fa-solid fa-moon"></i></button>
      <button class="icon-btn" id="openUpload" title="Upload" aria-label="Upload song"><i class="fa-solid fa-cloud-arrow-up"></i></button>
    </div>
  </div>
</header>

<main class="container">
  <section class="hero">
    <div class="hero-left">
      <h1 class="title">Your Music Library</h1>
      <div class="subtitle">Upload, browse, favorite and play. Persistent storage enabled (IndexedDB).</div>

      <div style="display:flex;gap:12px;align-items:center">
        <div class="search" aria-label="Search">
          <i class="fa-solid fa-magnifying-glass" style="color:var(--muted)"></i>
          <input id="search" placeholder="Search artist, album or song..." aria-label="Search songs">
        </div>

        <div class="tabs" role="tablist" aria-label="Views">
          <button id="tabHome" class="tab active" role="tab" aria-selected="true">Home</button>
          <button id="tabFavs" class="tab" role="tab" aria-selected="false">Favorites</button>
        </div>
      </div>
    </div>

    <div class="quick" aria-hidden="true">
      <div style="font-size:13px;color:var(--muted)">Quick actions</div>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="showAll">All</button>
        <button class="btn" id="showFavs">Favorites</button>
      </div>
    </div>
  </section>

  <h3 id="mainSectionTitle" style="margin-top:6px">Library</h3>

  <div id="grid" class="grid" aria-live="polite" aria-atomic="true"></div>
  <div id="noResults" class="no-results" style="display:none">No results — try another keyword.</div>

  <h3 class="section-title" style="margin-top:28px">Upload</h3>
  <div class="upload-area" id="uploadArea" role="button" tabindex="0" aria-label="Upload songs">
    <div><i class="fa-solid fa-cloud-arrow-up" style="font-size:28px;color:var(--accent)"></i></div>
    <div style="margin-top:10px;font-weight:600">Drag & drop or click to select</div>
    <div style="color:var(--muted);margin-top:6px;font-size:13px">Uploaded songs are persistent in browser storage (IndexedDB).</div>
    <input id="fileInput" type="file" accept="audio/*" style="display:none"/>
  </div>
</main>

<!-- Lyrics modal -->
<div id="lyricsModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="lyricsTitle">
    <button id="closeModal" style="float:right;border:none;background:transparent;color:var(--muted);font-size:18px;cursor:pointer" aria-label="Close lyrics">&times;</button>
    <h3 id="lyricsTitle">Lyrics</h3>
    <pre id="lyricsContent" style="white-space:pre-wrap;color:var(--muted)"></pre>
  </div>
</div>

<!-- Now playing modal -->
<div id="nowPlayingModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="nowPlayingTitle">
    <button id="closeNowPlaying" style="align-self:flex-start;border:none;background:transparent;color:var(--muted);font-size:18px;cursor:pointer" aria-label="Back to player">&larr; Back</button>
    <div class="now-left">
      <img id="nowPlayingCover" class="now-playing-cover" src="" alt="Now playing cover">
    </div>
    <div class="now-right">
      <div>
        <div class="now-title" id="nowPlayingTitle">Not playing</div>
        <div class="now-artist" id="nowPlayingArtist">—</div>
      </div>

      <div class="now-controls" role="group" aria-label="Playback controls">
        <button class="btn" id="nowPrev" title="Previous"><i class="fa-solid fa-backward"></i></button>
        <button class="now-big-play" id="nowPlay" title="Play/Pause"><i class="fa-solid fa-play"></i></button>
        <button class="btn" id="nowNext" title="Next"><i class="fa-solid fa-forward"></i></button>
      </div>

      <div style="width:100%;margin-top:8px;">
        <div class="progress-row">
          <div class="time" id="nowTimeCurrent">0:00</div>
          <div class="progress" id="nowProgress" aria-label="Now playing progress">
            <div class="buffer" id="nowBuffer"></div>
            <div class="bar" id="nowBar"></div>
            <div class="thumb" id="nowThumb"></div>
          </div>
          <div class="time" id="nowTimeDuration">0:00</div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Bottom player -->
<div class="player" id="playerBar" title="Open now playing" aria-hidden="false">
  <div class="track" role="button" aria-label="Open now playing">
    <img id="playerCover" src="" alt="cover" />
    <div class="meta">
      <div class="t" id="playerTitle">Not playing</div>
      <div class="a" id="playerArtist">—</div>
    </div>
  </div>

  <div class="progress-wrap">
    <div class="progress-row">
      <div class="time" id="timeCurrent">0:00</div>
      <div class="progress" id="progress" aria-label="Playback progress">
        <div class="buffer" id="bufferBar"></div>
        <div class="bar" id="progressBar"></div>
        <div class="thumb" id="progressThumb"></div>
      </div>
      <div class="time" id="timeDuration">0:00</div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div class="controls-compact" role="group" aria-label="Player controls">
        <button class="btn" id="prevBtn" title="Previous"><i class="fa-solid fa-backward"></i></button>
        <button class="play-btn" id="playerPlay" title="Play/Pause"><i class="fa-solid fa-play"></i></button>
        <button class="btn" id="nextBtn" title="Next"><i class="fa-solid fa-forward"></i></button>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <select id="speedSelect" class="btn" title="Playback speed" aria-label="Playback speed">
          <option value="1">1x</option><option value="0.5">0.5x</option><option value="0.75">0.75x</option><option value="1.25">1.25x</option><option value="1.5">1.5x</option><option value="2">2x</option>
        </select>
        <button id="repeatBtn" class="btn" title="Toggle repeat"><i class="fa-solid fa-retweet"></i></button>
      </div>
    </div>
  </div>

  <audio id="audioPlayer"></audio>
</div>

<script>
/* ----- DB ----- */
let db;
const openReq = indexedDB.open('musicLibrary', 1);
openReq.onupgradeneeded = e => { db = e.target.result; if(!db.objectStoreNames.contains('songs')) db.createObjectStore('songs', {keyPath:'id'}); };
openReq.onsuccess = e => { db = e.target.result; loadSongsFromDB(); };
openReq.onerror = e => console.error('DB', e);

/* ----- DOM shortcuts ----- */
const $ = id => document.getElementById(id);
const grid = $('grid'), noResults = $('noResults'), search = $('search');
const favoritesCount = $('favoritesCount'), toggleTheme = $('toggleTheme'), uploadArea = $('uploadArea'), fileInput = $('fileInput');
const lyricsModal = $('lyricsModal'), lyricsTitle = $('lyricsTitle'), lyricsContent = $('lyricsContent'), closeModal = $('closeModal');
const playerCover = $('playerCover'), playerTitle = $('playerTitle'), playerArtist = $('playerArtist');
const playerPlay = $('playerPlay'), playerBar = $('playerBar'), audio = $('audioPlayer');
const progressMain = $('progress'), barMain = $('progressBar'), thumbMain = $('progressThumb'), bufferMain = $('bufferBar');
const timeCurrent = $('timeCurrent'), timeDuration = $('timeDuration');
const nowModal = $('nowPlayingModal'), closeNow = $('closeNowPlaying'), nowCover = $('nowPlayingCover'), nowTitle = $('nowPlayingTitle'), nowArtist = $('nowPlayingArtist'), nowPlay = $('nowPlay'), nowPrev = $('nowPrev'), nowNext = $('nowNext');
const nowProgress = $('nowProgress'), nowBar = $('nowBar'), nowThumb = $('nowThumb'), nowBuffer = $('nowBuffer'), nowTimeCurrent = $('nowTimeCurrent'), nowTimeDuration = $('nowTimeDuration');
const prevBtn = $('prevBtn'), nextBtn = $('nextBtn'), speedSelect = $('speedSelect'), repeatBtn = $('repeatBtn');
const showAll = $('showAll'), showFavs = $('showFavs'), openUpload = $('openUpload');
const tabHome = $('tabHome'), tabFavs = $('tabFavs'), mainSectionTitle = $('mainSectionTitle');

/* ----- State ----- */
let songs = [], favorites = JSON.parse(localStorage.getItem('ml_favs')||'[]'),
    currentPlaylist = [], playingId = null, currentObjectUrl = null,
    wasPlayingBeforeSeek = false, isSeeking = false, activeView = 'home';

/* ----- Util ----- */
const setFavs = () => { favorites = [...new Set(favorites)]; localStorage.setItem('ml_favs', JSON.stringify(favorites)); favoritesCount.textContent = `${favorites.length} favorite${favorites.length===1?'':'s'}`; };
const escapeHtml = s => String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);
const uid = () => 'u'+Date.now().toString(36);
const formatTime = s => { if(!s||isNaN(s)) return '0:00'; s=Math.floor(s); const m=Math.floor(s/60), sec=s%60; return m+':'+(sec<10?'0':'')+sec; };
const getBlobUrl = blob => URL.createObjectURL(blob);
const revokeUrl = () => { if(currentObjectUrl){ try{ URL.revokeObjectURL(currentObjectUrl); }catch{} currentObjectUrl = null; } };

/* ----- Render ----- */
function createCard(song){
  const d = document.createElement('div'); d.className='card';
  d.innerHTML = `
    <img class="cover" src="${song.cover}" alt="${escapeHtml(song.title)} cover">
    <div class="card-body">
      <div class="title-sm">${escapeHtml(song.title)}</div>
      <div class="artist">${escapeHtml(song.artist)}</div>
      <div class="card-row">
        <button class="btn play-now" data-id="${song.id}" aria-label="Play ${escapeHtml(song.title)}"><i class="fa-solid fa-play"></i> Play</button>
        <button class="btn view-lyrics" data-id="${song.id}" title="Lyrics" aria-label="View lyrics"><i class="fa-solid fa-file-lines"></i></button>
        <button class="btn fav" data-id="${song.id}" title="Favorite" aria-label="Toggle favorite"><i class="fa-solid fa-heart"></i></button>
        <button class="btn delete-song" data-id="${song.id}" title="Delete" aria-label="Delete song"><i class="fa-solid fa-trash-can"></i></button>
      </div>
    </div>`;
  // bindings
  d.querySelector('.play-now').onclick = e => { e.stopPropagation(); playSong(song.id); openNowModal(); };
  d.querySelector('.view-lyrics').onclick = e => { e.stopPropagation(); showLyrics(song.id); };
  const favBtn = d.querySelector('.fav');
  if(favorites.includes(song.id)) favBtn.classList.add('active');
  favBtn.onclick = e => {
    e.stopPropagation();
    if(favorites.includes(song.id)) favorites = favorites.filter(x=>x!==song.id);
    else favorites.push(song.id);
    setFavs();
    if(activeView === 'favorites') showFavoritesView(); else renderGrid(currentPlaylist);
  };
  d.querySelector('.delete-song').onclick = e => {
    e.stopPropagation();
    if(!confirm(`Delete "${song.title}" by ${song.artist}? This will remove it from browser storage (IndexedDB).`)) return;
    const tx = db.transaction('songs','readwrite'); const store = tx.objectStore('songs');
    store.delete(song.id);
    tx.oncomplete = () => {
      songs = songs.filter(s=>s.id!==song.id);
      favorites = favorites.filter(f=>f!==song.id); setFavs();
      if(playingId === song.id){ audio.pause(); audio.removeAttribute('src'); revokeUrl(); playingId = null; playerTitle.textContent = 'Not playing'; playerArtist.textContent = '—'; playerCover.src=''; playerPlay.innerHTML = '<i class="fa-solid fa-play"></i>'; }
      if(activeView === 'favorites') showFavoritesView(); else showHomeView();
    };
    tx.onerror = () => alert('Failed to delete the song.');
  };
  return d;
}
function renderGrid(list){
  grid.innerHTML = '';
  if(!list || list.length===0){ noResults.style.display='block'; return; }
  noResults.style.display='none';
  list.forEach(s => grid.appendChild(createCard(s)));
}

/* ----- Views ----- */
function showHomeView(){ activeView='home'; tabHome.classList.add('active'); tabFavs.classList.remove('active'); mainSectionTitle.textContent='Library'; currentPlaylist=[...songs]; renderGrid(currentPlaylist); }
function showFavoritesView(){ activeView='favorites'; tabFavs.classList.add('active'); tabHome.classList.remove('active'); mainSectionTitle.textContent='Favorites'; currentPlaylist = favorites.map(id => songs.find(s=>s.id===id)).filter(Boolean); renderGrid(currentPlaylist); }

/* ----- Load / Save ----- */
function loadSongsFromDB(){
  const tx = db.transaction('songs','readonly'), store = tx.objectStore('songs'), req = store.getAll();
  req.onsuccess = () => {
    songs = req.result || [];
    songs = songs.map(s => { if(s.audio && s.audio.byteLength !== undefined) s.audio = new Blob([s.audio], {type: s.audioType || 'audio/mpeg'}); return s; });
    setFavs();
    showHomeView();
  };
}

/* ----- Playback ----- */
function setSourceFromSong(s){
  revokeUrl();
  if(s.audio instanceof Blob){ currentObjectUrl = getBlobUrl(s.audio); audio.src = currentObjectUrl; }
  else if(typeof s.audio === 'string' && s.audio.startsWith('blob:')){ currentObjectUrl = s.audio; audio.src = currentObjectUrl; }
  else audio.removeAttribute('src');
}
function playSong(id){
  const s = songs.find(x=>x.id===id); if(!s) return;
  playingId = id; playerCover.src = s.cover; playerTitle.textContent = s.title; playerArtist.textContent = s.artist;
  setSourceFromSong(s);
  audio.play().catch(()=>{ /* autoplay prevented */ });
  syncNowPlaying();
}
function togglePlay(){ if(!audio.src) return; if(audio.paused) audio.play(); else audio.pause(); }
playerPlay.addEventListener('click', e => { e.stopPropagation(); togglePlay(); });
nowPlay.addEventListener('click', e => { e.stopPropagation(); togglePlay(); });

prevBtn.addEventListener('click', e => { e.stopPropagation(); nav(-1); });
nextBtn.addEventListener('click', e => { e.stopPropagation(); nav(1); });
nowPrev.addEventListener('click', e => { e.stopPropagation(); nav(-1); });
nowNext.addEventListener('click', e => { e.stopPropagation(); nav(1); });

function nav(dir){
  if(!playingId) return;
  const idx = currentPlaylist.findIndex(s=>s.id===playingId);
  const nextIdx = idx + dir;
  if(nextIdx >= 0 && nextIdx < currentPlaylist.length) playSong(currentPlaylist[nextIdx].id);
}

/* ----- Sync UI ----- */
function syncNowPlaying(){
  const s = songs.find(x=>x.id===playingId);
  nowCover.src = playerCover.src;
  nowTitle.textContent = playerTitle.textContent;
  nowArtist.textContent = playerArtist.textContent;
  nowPlay.innerHTML = audio.paused ? '<i class="fa-solid fa-play"></i>' : '<i class="fa-solid fa-pause"></i>';
  playerPlay.innerHTML = audio.paused ? '<i class="fa-solid fa-play"></i>' : '<i class="fa-solid fa-pause"></i>';
}
audio.addEventListener('play', syncNowPlaying);
audio.addEventListener('pause', syncNowPlaying);

/* ----- Progress ----- */
function updateProgressUI(){
  const cur = audio.currentTime || 0, dur = audio.duration || 0, pct = dur ? (cur/dur)*100 : 0;
  barMain.style.width = nowBar.style.width = pct + '%';
  thumbMain.style.left = nowThumb.style.left = pct + '%';
  timeCurrent.textContent = nowTimeCurrent.textContent = formatTime(cur);
  timeDuration.textContent = nowTimeDuration.textContent = formatTime(dur);
  bufferMain.style.width = nowBuffer.style.width = (()=>{ try{ const b = audio.buffered; if(!b.length) return '0%'; const end = b.end(b.length-1); return Math.min(100,(end/dur)*100)+'%'; }catch{return '0%'} })();
}
audio.addEventListener('timeupdate', ()=>{ if(!isSeeking) updateProgressUI(); });
audio.addEventListener('loadedmetadata', updateProgressUI);
audio.addEventListener('progress', updateProgressUI);

/* ----- Seek handlers ----- */
function attachSeek(progressEl){
  progressEl.addEventListener('mousedown', e => {
    e.stopPropagation();
    isSeeking = true; wasPlayingBeforeSeek = !audio.paused; if(wasPlayingBeforeSeek) audio.pause();
    seekTo(e, progressEl);
    const onMove = ev => seekTo(ev, progressEl);
    const onUp = ev => { seekTo(ev, progressEl); isSeeking = false; if(wasPlayingBeforeSeek) audio.play(); document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
  progressEl.addEventListener('click', e => { e.stopPropagation(); seekTo(e, progressEl); });
}
function seekTo(e, progressEl){
  const rect = progressEl.getBoundingClientRect();
  const x = (e.clientX ?? (e.touches && e.touches[0].clientX)) - rect.left;
  const pct = Math.max(0, Math.min(1, x/rect.width));
  if(audio.duration) audio.currentTime = pct * audio.duration;
}
attachSeek(progressMain); attachSeek(nowProgress);

/* ----- Search / Filters ----- */
$('search').addEventListener('input', e => {
  const q = e.target.value.trim().toLowerCase();
  if(activeView === 'favorites'){
    currentPlaylist = favorites.map(id => songs.find(s=>s.id===id)).filter(Boolean).filter(s => s.title.toLowerCase().includes(q) || s.artist.toLowerCase().includes(q));
  } else {
    currentPlaylist = q ? songs.filter(s => s.title.toLowerCase().includes(q) || s.artist.toLowerCase().includes(q)) : [...songs];
  }
  renderGrid(currentPlaylist);
});
$('showFavs').addEventListener('click', () => { showFavoritesView(); });
$('showAll').addEventListener('click', () => { showHomeView(); });

tabHome.addEventListener('click', showHomeView);
tabFavs.addEventListener('click', showFavoritesView);

/* ----- Theme toggle ----- */
toggleTheme.addEventListener('click', () => {
  document.documentElement.classList.toggle('light');
  const isLight = document.documentElement.classList.contains('light');
  toggleTheme.innerHTML = isLight ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
  toggleTheme.setAttribute('aria-pressed', isLight ? 'true' : 'false');
});

/* ----- Upload ----- */
openUpload.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('keydown', e => { if(e.key === 'Enter' || e.key === ' ') fileInput.click(); });

fileInput.addEventListener('change', e => {
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const id = uid();
    const song = { id, title: f.name.replace(/\.[^/.]+$/,''), artist: 'You (uploaded)', cover: 'https://picsum.photos/seed/'+id+'/600/400', lyrics: '', audio: new Blob([ev.target.result], {type: f.type}), audioType: f.type };
    const tx = db.transaction('songs','readwrite'); tx.objectStore('songs').put(song);
    tx.oncomplete = () => {
      songs.unshift(song);
      if(activeView === 'favorites') showFavoritesView(); else showHomeView();
    };
    tx.onerror = () => alert('Failed to save uploaded song.');
  };
  reader.readAsArrayBuffer(f);
});

/* ----- Lyrics modal ----- */
function showLyrics(id){
  const s = songs.find(x=>x.id===id); if(!s) return;
  lyricsTitle.textContent = `${s.title} — ${s.artist}`; lyricsContent.textContent = s.lyrics || 'No lyrics available.'; lyricsModal.classList.add('open'); lyricsModal.setAttribute('aria-hidden','false');
}
closeModal.addEventListener('click', ()=>{ lyricsModal.classList.remove('open'); lyricsModal.setAttribute('aria-hidden','true'); });
lyricsModal.addEventListener('click', e => { if(e.target === lyricsModal){ lyricsModal.classList.remove('open'); lyricsModal.setAttribute('aria-hidden','true'); } });

/* ----- Now playing modal open/close (no pause) ----- */
function openNowModal(){ if(!playingId && !audio.src) return; nowModal.classList.add('open'); nowModal.setAttribute('aria-hidden','false'); syncNowPlaying(); updateProgressUI(); }
function closeNowModalNoPause(){ nowModal.classList.remove('open'); nowModal.setAttribute('aria-hidden','true'); syncNowPlaying(); }

playerBar.addEventListener('click', () => openNowModal());
closeNow.addEventListener('click', e => { e.stopPropagation(); closeNowModalNoPause(); });
nowModal.addEventListener('click', e => { if(e.target === nowModal) closeNowModalNoPause(); });

/* ----- Playback extras ----- */
speedSelect.addEventListener('change', () => audio.playbackRate = parseFloat(speedSelect.value) || 1);
repeatBtn.addEventListener('click', e => { e.stopPropagation(); repeatBtn.classList.toggle('active'); audio.loop = repeatBtn.classList.contains('active'); });

/* ----- Init / misc ----- */
function init(){ if(!db) return; loadSongsFromDB(); setFavs(); }
document.addEventListener('visibilitychange', () => { if(!document.hidden) syncNowPlaying(); });
init();
</script>
</body>
</html>
